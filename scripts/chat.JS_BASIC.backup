function getRandomAlphanumericChar() {
    const chars = "ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789"; //
    // Generate a random index based on the string length
    const randomIndex = Math.floor(Math.random() * chars.length);
    // Return the character at that random index
    return chars.charAt(randomIndex); //
  }
  
async function IRC_CLIENT() {
    ECHOOFF();

    await SLOWPRINT("WELCOME to JPLY CHAT\n", 15);
    await SLOWPRINT("--------------------\n\n", 15);
    await SLOWPRINT("/quit for main menu\n\n", 15);
    await SLOWPRINT("/ignore nick\n\n", 15);


    const nick = "JPLY_BBS_"+getRandomAlphanumericChar()+"_"+NICK;//await INPUT("NICK: ");
    if (!nick) return;

    const channel = "#VoxAssist";//await INPUT("CHANNEL (#): ");
    if (!channel) return;

    await SLOWPRINT("\nCONNECTING...\n\n", 10);

    const ws = new WebSocket("wss://amjp.psy-k.org:9001");

    let connected = false;

    // --- IGNORE LIST ---
    const ignoreList = new Set(["doraemon"]);


    ws.onopen = () => {
        ws.send(JSON.stringify({
            type: "connect",
            nick: nick,
            channel: channel
        }));
    };

    ws.onerror = () => {
        PRINT("\n*** CONNECTION ERROR ***\n");
    };

    ws.onclose = () => {
        PRINT("\n*** DISCONNECTED ***\n");
    };

    ws.onmessage = async (ev) => {
        let data;
        try {
            data = JSON.parse(ev.data);
        } catch {
            return;
        }

        if (!data.line) return;
        const line = data.line;

        // Welcome / connected
        if (line.includes(" 001 ")) {
            connected = true;
            PRINT("*** CONNECTED ***\n");
            return;
        }

        // JOIN
        let m = line.match(/^:([^!]+)!.* JOIN :(.*)$/);
        if (m) {
            PRINT(`*** ${m[1]} joined ${m[2]}\n`);
            return;
        }

        // PART
        m = line.match(/^:([^!]+)!.* PART ([^ ]+)/);
        if (m) {
            PRINT(`*** ${m[1]} left ${m[2]}\n`);
            return;
        }

        // PRIVMSG
        m = line.match(/^:([^!]+)!.* PRIVMSG ([^ ]+) :(.*)$/);
        if (m) {
            const fromNick = m[1];
            const text = m[3];

            // ðŸ”• Ignore check
            if (ignoreList.has(fromNick.toLowerCase())) {
                return;
            }

            PRINT(`<${fromNick}> ${text}\n`, 3);
            return;
        }
    };

    // ------------------
    // INPUT LOOP
    // ------------------
    while (true) {
        const text = await INPUT();
        if (!text) continue;

        // Quit
        if (text === "/quit") {
            ws.close();
            break;
        }

        // /ignore commands
        if (text.startsWith("/ignore")) {
            const parts = text.split(" ").filter(Boolean);

            // /ignore
            if (parts.length === 1) {
                if (ignoreList.size === 0) {
                    PRINT("*** Ignore list empty ***\n");
                } else {
                    PRINT("*** Ignored nicks: " +
                        Array.from(ignoreList).join(", ") +
                        " ***\n");
                }
                continue;
            }

            // /ignore nick
            const ignoreNick = parts[1].toLowerCase();
            ignoreList.add(ignoreNick);
            PRINT(`*** Ignoring ${ignoreNick} ***\n`);
            continue;
        }

        // /unignore nick
        if (text.startsWith("/unignore")) {
            const parts = text.split(" ").filter(Boolean);
            if (parts.length < 2) {
                PRINT("*** Usage: /unignore nick ***\n");
                continue;
            }

            const unignoreNick = parts[1].toLowerCase();
            if (ignoreList.delete(unignoreNick)) {
                PRINT(`*** Unignored ${unignoreNick} ***\n`);
            } else {
                PRINT(`*** ${unignoreNick} was not ignored ***\n`);
            }
            continue;
        }

        if (!connected) continue;

        // Normal chat
        ws.send(JSON.stringify({
            type: "msg",
            channel: channel,
            text: text
        }));
        //echo
        PRINT(nick+": "+text+"\n")
        //PRINT(`RETURN TO COLOR\n`, 3);
        COLOR(12,0);//return colro to default just in-case someone changed hte color
    }
}

await IRC_CLIENT();
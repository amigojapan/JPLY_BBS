<?php
header('Content-Type: text/plain');

error_reporting(E_ALL);
ini_set('display_errors', '1');
ini_set('display_startup_errors', '1');

if ($_SERVER['REQUEST_METHOD'] !== 'POST') {
    echo "ERROR:not POST method";
    exit;
}

// ---- POST PARAMETERS (same as register.php) ----
$nick = $_POST['nick'] ?? '';
$email    = $_POST['email']    ?? '';
$password = $_POST['pw'] ?? '';

// Basic validation
if ($email === '' || $password === '') {
    echo "ERROR:basic validation erro";
    exit;
}

try {
    // ---- OPEN SQLITE DATABASE ----
    // ⚠️ MUST be the SAME file used in register.php
    $db = new SQLite3(__DIR__ . '/userdb.sqlite3');

    // ---- FETCH USER ----
    // Email + nick match (safer than email alone)
    $stmt = $db->prepare(
        'SELECT pw FROM users
         WHERE email = :email AND nick = :nick
         LIMIT 1'
    );

    $stmt->bindValue(':email', $email, SQLITE3_TEXT);
    $stmt->bindValue(':nick', $nick, SQLITE3_TEXT);

    $result = $stmt->execute();
    $row = $result->fetchArray(SQLITE3_ASSOC);

    // User not found
    if (!$row) {
        echo "ERROR:User not found";
        exit;
    }

    /*
    // Verify password hash
    if (!password_verify($password, $row['pw'])) {
        echo "ERROR:invalid password";
        exit;
    }

    // ---- SUCCESS ----
    echo "OK";
    test if is logged in

    var response = await CURL('https://amjp.psy-k.org/JPLY_BBS/server_side/is_loged_in.php', {
    data: 'nick=test&pw=test&email=test'
    });
    PRINT(response);

*/
    // ---- RECREATE HASH ----
    $computedHash = hash('sha512', $row['salt'] . $password);

    if (!hash_equals($row['hash'], $computedHash)) {
        echo "ERROR:pw";
        exit;
    }
} catch (Exception $e) {
    echo "ERROR:".$e;
}
